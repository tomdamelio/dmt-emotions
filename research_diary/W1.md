Sabado 30 de Agosto
--------------------
[x] Armar en `docs/` el readme del proyecto con el orden en que deben correrse.
[x] Guardar los archivos de datos viejos en `../data/old/`
[x] Guardar la data originar en `../data/original/`
[x] Pushear el proyecto en un nuevo repo (ahora esta en el repo de Tomi)

Domingo 31 de Agosto
--------------------
[x] Editar `preprocess_eda.py` para usar 15 segundos extra (20:15 min DMT, 10:15 min Reposo) para plots m√°s limpios.
[x] Crear archivo `config.py` con todos los paths y datos de config del proyecto.
[x] Adaptar preprocess_eda.py para extraer todas las metricas de 
interes de EDA
[x] Hacer testeo exploratorio de la version actual de `preprocess_eda.py` en un nuevo script a guardarse en `./test`.
Este script debe testear las se√±ales de EDA extraidas para el sujeto de prueba (S04). Para eso, es necesario primero  filtrar el dataframe guardado en el .csv para quitar la columna ¬¥time¬¥. Luego de eso, con `eda_plot()` puedo plotear los 4 archivos resultantes.

Comentario -> Parece que la extracci√≥n de la actividad de SMNA no esta resuelta en NueroKit2, y de hecho parece que cvxEDA podria tener mejoras (e.g con transformers o a partir de sumar un prior sparse. Pero indagar esto va mas alla de los objetivos de este trabajo, y voy a continuar con los datos extraidos como variables de NeuroKit2).

[x] Generalizar `preprocess_eda.py` para que sea `preprocess_phys.py`y
y obtener asi todos los features tambien de resp y ecg (ademas de eda).
[x] Crear `test_phys_preprocessing.py` para testear que los plots esten bien para las 3 medidas (con la generalizacion de `preprocess_eda.py` a `preprocess_phys.py`).
[x] Correr `python scripts/preprocess_phys.py` que me deberia preprocesar todos los particiapantes (TODOS y no solo los validos).

Lunes 15 de Septiembre
[x] Modificar `test_phys_preprocessing.py`para que al correrlo (por ahora solo para el S01) me permita anotar manualmente en consola / terminal las anotaciones que luego se reflejaran en el json (ver los cambios que hice en el chat de cursor a la derecha, para entener el proceso).


[x] En `preprocess_phys.py`, implementar el metodo `kbk_scr()` de biosppy como metodo extra / complementario sobre la se√±al de EDA. Esto nos dara 3 arrays (i.e. SCR onsets, SCR peaks and SCR amplitudes) que deben combinarse en un unico DataFrame y guardarse como un archivo extra al archivo de eda, agregandole el sufijo (`_kbk_scr`). Por ejemplo, si el archivo resultante de EDA de correr `preprocess_phys.py` es `S02_dmt_session2_high.csv`, este nuevo archivo complementario sera  `S02_dmt_session2_high_kbk_scr.csv`

[x]  En `preprocess_phys.py`, implementar exactamente lo mismo que hice en el paso anterior con `kbk_scr()` pero con la funcion `emotiphai_eda()` (que tambien devuelve 3 arrays de onsets, peaks y amplitudes). Del mismo modo, el archivo resultante podria llamarse (a modo de ejemplo) `S02_dmt_session2_high_kbk_scr_emotiphai_eda.csv`


[x] Finalmente,  en `preprocess_phys.py` guardar un cuarto archivo complementario de EDA. Esta vez, se imlementara el metodo `biosppy.signals.eda.cvx_decomposition()` como metodo extra / complementario sobre la se√±al de EDA. Esto nos dara 3 arrays (i.e. edr, smna, edl) que debe guardarse como un archivo extra al archivo de eda, agregandole el sufijo (`_cvx_decomposition`). El resto de las cuatro variables que devuelve cvx_decomposition (i.e. tonic_coeff, linear_drift, res, obj) no quiero qeu se guarden. En este proceso por ejemplo, si el archivo resultante de EDA de correr `preprocess_phys.py` es `S02_dmt_session2_high.csv`, este nuevo archivo complementario sera  `S02_dmt_session2_high_cvx_decomposition.csv`

[x] Agregar en `preprocess_phys.py` algun paso de validacion para corroborar que los lenghts de los archivos de kbk_scr, emotiphai_eda y cvx_decomposition tenga la misma dimensioanlidad (imprimir los lenghts de ambos archivos e incluir un assert de eso)

Por ahora tengo implementado en `preprocess_phys.py` para obtener los features de las 3 se√±ales y ademas el emotiphai_eda y cvx_decomposition (kbk_scr lo borre por una cuestion de incompatibilidades de dependencias con numpu).
Recien chequee que los plots de `test_phys_preprocessing.py` me dan algo decente, asi que ahora dejo corriendo `preprocess_phys.py` para todos los participantes. `test_phys_preprocessing.py` todavia puede mejorarse, sobre todo tal vez se puede combinar la infom de emotiphai_eda con la info de cvx eda (todo junto en un mismo plot).
Ademas, tengo la idae de quedarme con la envolvente de SMNA como proxy de arousal (aunque tal vez el SCR extraido con el cxvEDA es suficiente)

[x] Quiero que en `test_phys_preprocessing.py`, al plot de cvxEDA le sumes los eventos extraido de "Emotiphai SCR". En concreto, quiero que en el plot de cvxEDA incluyas el `Onset` y el `Peak` como un punto en la serie temporal de cvxEDA. A su vez, representa `Amplitud` como una barra vertical qeu desciende desde el `Peak`. Tene en cuenta que el plot de cvxEDA esta en segundos mientras que el de Emotiphai tiene los timestamps en timepoints (sampling rate de 250Hz).

[x] Fijare si corrio bien `preprocess_phys.py` para todos los participantes

----
24/9
----

[x] Creo que esta fallando la forma en que se itera para buscar archivo en @test_phys_preprocessing.py.

Por ejemplo, el orden en que se estan procesando los archivos actualmente es el siguiente:

s01 ses02 dmt low 12 min eda
s01 ses 02 rest low 6 min eda

s01 ses02 dmt low 12 min ecg
s01 ses 02 rest low 6 min ecg

s01 ses02 dmt low 12 min resp
s01 ses 02 rest low 6 min resp

(luego no se proceso ni el s02 ni el s03, sino que pasa directamente al s04)

s04 ses01 dmt high 12 min eda
s04 ses01 rest high 6 min eda
s04 ses02 dmt low 12 min eda
s04 ses02 rest low 6 min eda

s04 ses01 dmt high 12 min ecg
s04 ses01 rest high 6 min ecg
s04 ses02 dmt low 12 min ecg
s04 ses02 rest low 6 min ecg

s04 ses01 dmt high 12 min resp
s04 ses01 rest high 6 min resp
s04 ses02 dmt low 12 min resp
s04 ses02 rest low 6 min resp

s05 ses01 dmt high 12 min eda
s05 ses01 resthigh 6 min eda
s05 ses02 dmt low 12 min eda
s05 ses02 rest low 6 min eda

s05 ses01 dmt high 12 min ecg
s05 ses01 resthigh 6 min ecg
s05 ses02 dmt low 12 min ecg
s05 ses02 rest low 6 min ecg

s05 ses01 dmt high 12 min resp
s05 ses01 resthigh 6 min resp
s05 ses02 dmt low 12 min resp
s05 ses02 rest low 6 min resp

(luego no se proceso ni el s06, s07 ni el s08, sino que pasa directamente al s09).


Chequear porque sucede esto, porque por ejemplo si vamos a `dmt_high` encontramos archivos para s02, s03, s06, s07, s08. Y en `dmt_low` encontramos a los sujetos s06, s07 y s08.

Sera que al iterar busca una combinaci√≥n exacta entre sesi√≥n y condici√≥n que si no encuentra pasa a la siguiente iteraci√≥n?

Revisar el archivo para dar respuesta a este problema en el procesamiento / iteraci√≥n de archivos en @test_phys_preprocessing.py



SEGUIR DESDE ACA ->
[ ]  Correr `test_phys_preprocessing.py` para ver archivo a archivo de cada participante si genera o no datos validos. Ir anotando este en algun archivo de logeo que luego `process_eda.py` tome como input para entender cuales son los archivos validos y cuales no. Comparar este logeo de archivos validos con las anotaciones manuales de Tomi a ver si coinciden.

Aca voy a poner las anotaciones generales que vaya teniendo de cada sujeto, uniendo con la data que tenia de acuerdo a anotaciones de Tomi tambien:

    -  La estimacion de HR es muy ruidosa, y estimo que eso va a ser asi para todos los participantes.
    - La medicion de respiracion parece ruidosa (mas en algunos sujetos que en otros), pero capaz es salvable. Deberia juntarme con Ignacio Rebollo para anlizar si tiene sentido ver esta data.
    - Revisar por que tengo este error:    `‚ö†Ô∏è  NeuroKit2 plotting failed: Length of values (112) does not match length of index (111)`. Esto me paso en el s13 eda dmt ses02 high. Intentar resolver a ver que esta sucediendo. Me paso en otros sujetos tambien.

# Sujetos se√±ales problematicas 

| Sujeto | Estado |
|--------|--------|
| S01    | INVALID | Faltan archivos de 1 sesion completa y no entiendo por que (buscarla y rechequear)
| S02    | INVALID |
| S03    | INVALID |
| S04    | v√°lido |
| S05    | v√°lido |
| S06    | v√°lido |
| S07    | v√°lido |
| S08    | DMT_2 (se√±al muerta), INVALID |
| S09    | v√°lido |
| S10    | DMT_2 (se√±al muerta), INVALID |
| S11    | DMT_2 (se√±al muerta), INVALID |
| S12    | DMT_2 (se√±al muerta, DMT_1 est√° bien), INVALID |
| S13    | v√°lido |
| S15    | DMT_2 (se√±al muerta), INVALID |
| S16    | v√°lido |
| S17    | v√°lido |
| S18    | v√°lido |
| S19    | v√°lido |
| S20    | v√°lido |

Faltan archivos del sujeto 01, 02 y 03:
  Missing files:
   üìÇ EDA:
      ‚ùå S01 - EDA DMT High Dose
      ‚ùå S01 - EDA Resting High Dose
      ‚ùå S02 - EDA DMT Low Dose
      ‚ùå S02 - EDA Resting Low Dose
      ‚ùå S03 - EDA DMT Low Dose
      ‚ùå S03 - EDA Resting Low Dose
   üìÇ ECG:
      ‚ùå S01 - ECG DMT High Dose
      ‚ùå S01 - ECG Resting High Dose
      ‚ùå S02 - ECG DMT Low Dose
      ‚ùå S02 - ECG Resting Low Dose
      ‚ùå S03 - ECG DMT Low Dose
      ‚ùå S03 - ECG Resting Low Dose
   üìÇ RESP:
      ‚ùå S01 - RESP DMT High Dose
      ‚ùå S01 - RESP Resting High Dose
      ‚ùå S02 - RESP DMT Low Dose
      ‚ùå S02 - RESP Resting Low Dose
      ‚ùå S03 - RESP DMT Low Dose
      ‚ùå S03 - RESP Resting Low Dose


[x] Revisar este error que tuve al correr @test_phys_preprocessing.py:    `‚ö†Ô∏è  NeuroKit2 plotting failed: Length of values (112) does not match length of index (111)`. Esto me paso en al procesar al sujeto `s13` ara el archivo de la se√±al de EDA en la condicion dmt high. Por que sucede este error? Hacer una prubea minima que intente  plotearlo con neurokit2 para entender que sucede especificamente con este sujeto. Crear un script especificamente para esta prueba minima de ploteo de la se√±al de eda de este archivo (que debe guardarse en `/test`)

[x] Crear un script en `./test` que lo que haga sea chequear en @validation_log.json cuales son los archivos que fueron marcados como "bad" en "category". Luego, si un sujeto (e.g. `s12`) tiene alguno de los dos archivos de la condicion `DMT` (`low` o `high`) como bad, ese sujeto debe marcarse como bad en un nuevo json que genere como output. Este json debe tener para cada se√±al separda (`eda`, `ecg` y `resp`) cuales son los sujetos marcados como `bad` (porquepara esa se√±al tiene uno de los dos archivos de la condicion DMT como `bad`).

SEGUIR DESDE ACA ->

[x] Revisar que los archivos marcados como bad para cada sujeto / se√±al sea correcta (ya lo estoy revisando con chatgpt)

[x] Con la informacion de validez de los datos guardada en @validation_log.json y considerando ahora los marcados como "bad subjects" para cada se√±al en @dmt_bad_subjects.json, quiero que me armes una lista para cada se√±al (eda, ecg y resp) con los sujetos validados (no "bad" ni vacios) para dicha se√±al (con valor de `notes` que sea `good` o `acceptable`). Quiero que agregues esto como 3 nuevas listas en el config.py file (i.e. `SUJETOS_VALIDADOS_EDA`, `SUJETOS_VALIDADOS_ECG`, `SUJETOS_VALIDADOS_RESP`)

[x] Buscar ahora cual es la mejor representacion para diferenciar entre dosis alta y dosis baja de EDA.
Ahora que ya tengo los datos de los participantes guardados `../dmt\data\derivatives\preprocessing\phys` para las 3 se√±ales de interes (`ecg`, `eda`, `resp`) y que tengo en @config.py los sujetos validos para cada se√±al (en las listas `SUJETOS_VALIDADOS_EDA`, `SUJETOS_VALIDADOS_ECG` y `SUJETOS_VALIDADOS_RESP` dentro de ese archivo), puedo empezar a inspeccionar los datos de la se√±al de EDA para los sujetos validos.
Para empezar, hacer ploteos por participante comparando el AUC de SMNA (columna `SMNA` de `*cvx_decomposition.csv`) para el caso de dosis alta y dosis baja. Esto nos va a ayudar a explorar mejor los datos sujeto a sujeto (nos falta todavia ese insight).
De este modo, para todos los sujetos validos de la se√±al EDA, hacer plots individuales por sujeto en el que se compare el SMNA de dosis alta vs dosis baja. El Area bajo la curva debe estar pintada, con una opacidad media (para que se note cuando ambos colores se superponen). Se espera que, sobre todo en la primera mitad de los registros, el AUC de SMNA para dosis alta supere a dosis baja.
Guardar estos plots por sujeto en `/test/eda/smna`.

[x] Quiero que cada participante tenga un unico plot con dos subplots: el subplot de la dosis (dmt high vs dmt low) y el subplot de resting state (resting state - high vs resting state - low).

[ ] Mejora estos plots consdierando que alguno de estos graficos seguramente se muestre comom ejemplo en el paper qeu estare enviando a Nature. Por lo tanto, debe tener mejor esteticaa / realizacion. Corregi lo necesario considerando esto, sin complejizar demasiado el script.

SEGUIR DESDE ACA ->

Takeaways del analisis estadistico (guardado en smna_auc_2x2_boxplot.png)

‚Äútakeaways‚Äù:

Efecto de Tarea (RS vs DMT) robusto y consistente. Global 2√ó2: Task significativo (F=15.94, p=0.0025). Por minuto, el efecto se replica en la mayor√≠a de ventanas (0‚Äì7 y 9; p‚âà0.001‚Äì0.050) y en el agregado 0:00‚Äì4:59 (p=0.0012). Interpretaci√≥n: DMT muestra AUC mayor que RS de forma estable.

Dosis (Low vs High) no muestra efecto global, pero emerge en ventanas tard√≠as: sin efecto global (p=0.147), con se√±ales por minuto alrededor de min 4‚Äì5 y especialmente min 8 (p=0.013). Patr√≥n: High > Low aparece cuando avanza la sesi√≥n.

Interacci√≥n Task√óDose: tendencia global y pico puntual. Globalmente marginal (p=0.0789). Por minuto, significativa en min 8 (p=0.0246) y cercana en 2, 4‚Äì6 y 9. Sin embargo, tras correcci√≥n Holm a trav√©s de minutos no se mantiene (p_corr‚âà0.25), por lo que la evidencia de interacci√≥n es sugerente pero no concluyente.

Comparaciones apareadas confirman el patr√≥n esperado de ‚ÄúRCT intra-sujeto‚Äù. En RS: Low vs High nunca difiere (todos p>0.22). En DMT: Low vs High s√≠ difiere en ventanas espec√≠ficas (min 4: p=0.033; min 8: p=0.0118; ~min 5/9: p‚âà0.05). Esto explica la tendencia a interacci√≥n: la dosis modula la respuesta solo en DMT, no en RS.

Medias de celda globales coherentes con el patr√≥n. RS: Low 6.22 ‚Üí High 3.90 (ligera baja con dosis). DMT: Low 16.11 ‚Üí High 27.59 (fuerte subida con dosis). Resultado: gran efecto de Task y tendencia a interacci√≥n impulsada por DMT.

Conclusi√≥n operativa. Hay un efecto principal fuerte de Tarea, evidencia de efecto de Dosis en fases medias‚Äìtard√≠as dentro de DMT, y se√±ales de interacci√≥n que requieren confirmaci√≥n con control por m√∫ltiples comparaciones (o un modelo que integre el eje tiempo).

[ ] Prepar√° los datos en formato ‚Äúlong‚Äù (columnas: subject, minute [0‚Äì9], Task {RS,DMT}, Dose {Low,High}, AUC) y cre√° minute_c = minute - mean(minute). Ajust√° primero un LME con statsmodels (MixedLM) con efectos fijos AUC ~ Task*Dose + minute_c + Task:minute_c + Dose:minute_c (dejar Task:Dose:minute_c solo si converge/est√° justificado) y efectos aleatorios ~ 1 | subject; si converge y aporta varianza, sub√≠ a ~ 1 + minute_c | subject. En paralelo, corr√© un an√°lisis de sensibilidad con GEE (statsmodels.GEE) usando la misma f√≥rmula de fijos y AR(1) para autocorrelaci√≥n temporal dentro de sujeto. Defin√≠ tres familias de hip√≥tesis: (i) Task (incluye Task y Task:minute_c), (ii) Dose (incluye Dose y Dose:minute_c), (iii) Task:Dose (y Task:Dose:minute_c si se incluy√≥); para cada familia, constru√≠ contrastes (p.ej., DMT vs RS promediando minutos; pendiente vs minuto; High‚ÄìLow dentro de DMT y dentro de RS) y aplic√° BH‚ÄìFDR a los p‚Äêvalues resultantes. Como alternativa/validaci√≥n no param√©trica, corr√© un cluster/permutation test 1D sobre la serie pareada (High‚ÄìLow) por minuto por separado en RS y DMT (permute signos a nivel sujeto, umbral inicial p‚âà0.05, ‚â•10 000 permutaciones; pod√©s usar mne.stats.permutation_cluster_1samp_test). Entregables: tabla de coeficientes (Œ≤), CI95% y p (raw y FDR) para cada contraste; varianzas aleatorias del LME; consistencia LME vs GEE; resultados del test por cl√∫ster (minutos y p de cada cl√∫ster); y figuras: efecto principal de Task/Dose y, si procede, interacci√≥n vs minute_c.

[ ]  Curva de AUC acumulada (cumAUC) High vs Low
- Por sujeto y condici√≥n, calcul√° cumAUC[m] = sum(AUC[0:m]).
- Grafic√° media de cumAUC para High y Low con IC95% por bootstrap estratificado por sujeto (resample sujetos con reemplazo; dentro de cada resample manten√© sus 20 observaciones emparejadas Task√óDose). L√≠neas finas por sujeto con alpha bajo.
- A√±ad√≠ banda de diferencia cumAUC_High ‚àí cumAUC_Low con IC95% bootstrap; resalt√° los minutos donde el IC no cruza 0 (interpretable como mayor ‚Äúcarga total‚Äù bajo High).


[ ] Hacer tambien el plot para comparar dosis baja y dosis alta para el EDR (columna `EDR` de `*cvx_decomposition.csv`) y EDL (columna `EDL` de `*cvx_decomposition.csv`) por participante (tambien quedandote con los priemeros 10 minutos de registro). Es decir, ahora en `/test/eda/scr`(para `EDR`) y `/test/eda/scl`(para `EDL`) se deben guardar plots analogos a los que se guarda actualmente en `test\eda\smna_10min` pero con esta otra data especifciada (i.e. edr y edl).
Vamos a empezar primero con EDR (i.e. SCR).

[ ] A Ahora vamos a hacer ECL (i.e. SCL)

[ ] Adaptar `process_eda.py` para replicar figuara de EDA y HR de Tomi, pero con nueva forma de obtencion de los datos segun fueron guardados al correr `preprocess_eda.py`. Ya fui adaptandolo, sacando metricas de SMNA, etc, pero no me convencio para nada el resultado. Diego me propuso qeu si esta muy ruidoso puedo fitear un pilonomio a eso, pero no se. Tambien algo tipo el area bajo la curva (AUC) deberia funcionar bien, probar AUC de SMNA y de EDR a ver que funciona mejor.

[ ] Hacer espectrograma pero con los datos de EDA y ECG (dos figuras distitnas), a nivel exploratorio.

[ ] Hacer el equivalente a un ANOVA no parametrico (2x2) con el AUC de SMNA, asi aprovechamos tambien la linea de base. Quedarme solamnete con los 10 minutos iniclales de cada registro.

[ ] Con esto, hablarle a Enzo para avanzar con el paper

[ ] Que pasa si comparamos el PSD de EEG en los momentos de SMNA > 0 comparados con SMNA = 0?. COmo cambia el PSD dependiendo la actividad autonomica?

[ ] Documentar todos los cambios realizados

[ ] Analisis de ECG. En el S02 ECg Rest ses 02 high hay que corregir la se√±al de ECG, pero es salvable interpolando  desde el segundo 210 hasta el segundo 310.